# Role
你是一名精通 Python 地理空间数据处理的专家，熟练使用 `geopandas`, `rasterio`, `rasterstats`, `numpy` 和 `pandas` 库。请根据以下逻辑编写完整的 Python 代码。

# Context & Objective
我需要分析中国光伏电站的“一地两用”效率。
任务核心是：
1. 计算现有“共址型光伏（APV）”相对于其周边农田的 NDVI 保持率（效率）。
2. 将这些效率标准应用到“竞争型光伏（CAPV）”上，模拟如果将竞争型改造为共址型，能挽回多少耕地生产力（NDVI）。

# Data Paths
* **NDVI 数据**: `D:\pv\data\ndvi`
    * 该文件夹包含12个 `.tif` 文件，分别代表1月到12月的 NDVI。
* **光伏数据 (APV)**: `D:\pv\result\result_merge_postprocess\apv_2023_all_merge_block.shp`
    * 代表现有的共址型光伏斑块。
* **气候分区**: `D:\pv\data\Chinese_climate\Chinese_climate.shp`
    * 包含7个气候区几何信息。
* **GRW 数据**: `D:\pv\grw_microsoft\grw_2024q2_China_only.gpkg`
    * 用于提取竞争型光伏（CAPV）。

# Workflow Steps

## 1. NDVI Preprocessing (Annual Max)
* **逻辑**: 不需要计算累积值 (CumNDVI)。我们需要获取地块在一年中的**最佳生长状态**。
* **操作**:
    1.  遍历 `D:\pv\data\ndvi` 下的12个栅格文件。
    2.  读取数据并乘以 **0.0001** (缩放到 -1 到 1)。
    3.  计算 **Annual Maximum NDVI**：对比12个月份，取每个像素位置的最大值。
    4.  生成一个内存中的 raster 对象或临时文件 `ndvi_max_2023.tif` 用于后续计算。

## 2. Prepare CAPV Data (GRW)
* **逻辑**: 从 GRW 数据集中筛选出占用耕地的光伏。
* **操作**:
    1.  读取 `grw_2024q2_China_only.gpkg`。
    2.  筛选条件：
        * `landcover_in_2018` 等于 `landcover_10` 或 `landcover_20`。
        * `construction_year` <= 2023。
    3.  保存为 `D:\pv\grw_microsoft\grw_2023_crop.shp`。

## 3. Calculate APV Efficiency Rates
* **逻辑**: 计算 `光伏区内部 NDVI` / `周边背景农田 NDVI` = `Rate`。
* **操作**:
    1.  **空间连接**: 将 `apv_2023_all_merge_block.shp` 与 气候分区数据连接，添加气候区属性。
    2.  **构建背景参照**:
        * 对每个 APV 斑块，创建 **2km - 6km 的环形缓冲区 (Ring Buffer)**。
    3.  **分区统计 (Zonal Statistics)**:
        * `ndvi_apv`: 统计 APV **斑块几何内部** 的 `ndvi_max` 均值。
        * `ndvi_base`: 统计 **环形缓冲区内** 的 `ndvi_max` 均值。
    4.  **计算比率**:
        * `rate_ndvi` = `ndvi_apv` / `ndvi_base`。
    5.  导出中间表格到 `D:\pv\scenario\apv_efficiency_rate.xlsx`。

## 4. Define Scenarios by Climate Zone
* **逻辑**: 获取每个气候区的效率阈值。
* **操作**:
    1.  按气候区名称分组。
    2.  计算 `rate_ndvi` 的分位数：
        * **Top 10% (High Efficiency)**: 90th percentile (0.9分位数)。
        * **Median**: 50th percentile。
        * **Bottom 10%**: 10th percentile。

## 5. Simulate Potential Recovery on CAPV
* **逻辑**: 假设 CAPV 采用上述三种效率标准，计算 NDVI 增量。
* **操作**:
    1.  读取步骤2生成的 `grw_2023_crop.shp`，并进行气候区空间连接。
    2.  **计算现状与潜力**:
        * `ndvi_capv_current`: 统计 GRW 斑块**内部**的 `ndvi_max` 均值。
        * `ndvi_capv_ref`: 统计 GRW 斑块 **2km-6km 环形缓冲区**的 `ndvi_max` 均值 (代表理论纯农田值)。
    3.  **应用情景**:
        * 根据气候区匹配对应的 Top/Median/Bottom Rate。
        * `Simulated_Top` = `ndvi_capv_ref` * `Top_Rate`
        * `Simulated_Med` = `ndvi_capv_ref` * `Median_Rate`
        * `Simulated_Low` = `ndvi_capv_ref` * `Bottom_Rate`
    4.  **计算增量 (Gain)**:
        * `Gain` = `Simulated_Top` - `ndvi_capv_current` (以此类推其他情景)。

## 6. Output Final Report
* **操作**: 按气候区汇总均值，输出到 `D:\pv\scenario\ndvi_climate_change.xlsx`。
* **表格列要求**:
    * `Climate_Zone` (索引)
    * `Current_CAPV_NDVI_Mean` (现状均值)
    * `Scenario_Top_NDVI_Mean` (Top情景预测均值)
    * `Scenario_Med_NDVI_Mean`
    * `Scenario_Low_NDVI_Mean`
    * `NDVI_Improvement_Top_Value` (Top情景下的绝对提升量: Predicted - Current)

# Constraints
* 处理栅格计算时请注意内存管理，如果数据量大，请使用分块处理或 `rasterstats` 的合适参数。
* 所有中间 shapefile 和结果 excel 均保存在指定路径。