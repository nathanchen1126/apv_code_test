# 角色设定
1、你是一名经验丰富的使用R语言进行绘图的专家，你需要为我完成绘制散点图，拟合的工作
# 流程
## 获取数据
1、数据集用xlsx保存在"D:\pv\area_stats_city.xlsx"
2、数据包括area_apv	area_grw	pv2023	apv_percent	capv_percent	cropland	ndvi七列
## 流程
1、绘制三幅散点图，保存到D:\pv\plot文件夹下
2、首先对七列数据做标准化，使得数值都在0-1之间，0值向右平移0.0001
3、绘制第一幅图，x轴为area_apv标准化后的数值，y轴为area_grw标准化后的数值。加入拟合线
4、绘制第二幅图，x轴为area_apv标准化后的数值，y轴为cropland标准化后的数值。加入拟合线
5、绘制第三幅图，x轴为area_apv标准化后的数值，y轴为ndvi标准化后的数值。加入拟合线
## 参考代码
library(tidyverse)
library(ggplot2)
library(readxl)
library(grid)
library(gridExtra)


# 设置字体兼容函数（用于 theme 中的 family 参数）
my_font <- ifelse(.Platform$OS.type == "windows", "宋体", "SimSun")

# 读取数据
df_path <- "D:/2浙江十五五土地计划课题/时空分析/土地利用计划管理-数据工程文件-到2025年.xlsx"
df <- read_excel(df_path, sheet = "图6.11.12")

# 数据清洗：去除缺失值和超出范围的数据
df_clean <- df %>%
  filter(
    !is.na(`地区生产总值（亿元）`),
    !is.na(`执行新增建设用地（亩）`),
    !is.na(年份),
    年份 %in% c(2020, 2021, 2022, 2023),
    `地区生产总值（亿元）` <= 12000,
    `地区生产总值（亿元）` > 0
  )

# 定义年份列表
years <- c(2020, 2021, 2022, 2023)

# 创建绘图函数
create_plot <- function(data, title_label) {
  # 计算 Spearman 相关系数及其 p 值
  cor_test <- cor.test(
    data$`地区生产总值（亿元）`, 
    data$`下达新增建设用地（亩）`, 
    method = "spearman",
    exact = FALSE  # 避免 ties 导致的精确计算问题
  )
  
  # 提取相关系数和 p 值
  rho <- round(cor_test$estimate, 3)
  p_value <- cor_test$p.value
  
  # 根据 p 值确定显著性星号
  p_signif <- ifelse(p_value < 0.001, "***",
                     ifelse(p_value < 0.01, "**",
                            ifelse(p_value < 0.05, "*", "ns")))
  
  # 构建标签文本
  label_text <- paste0("ρ = ", rho, p_signif)
  
  ggplot(data, aes(x = `地区生产总值（亿元）`, y = `执行新增建设用地（亩）`)) +
    geom_point(size = 2, color = "#EC0101", alpha = 0.5) +
    theme_bw() +
    theme(
      text = element_text(family = "Times New Roman"),
      axis.title = element_text(family = my_font, size = 12),
      axis.text = element_text(size = 10),
      axis.ticks.length = unit(0.25, "cm"),
      axis.ticks = element_line(size = 0.8),
      panel.border = element_rect(size = 1),
      panel.grid = element_blank(),
      plot.margin = margin(0.1, 0.1, 0.1, 0.1, "cm")
    ) +
    labs(title = title_label) +
    theme(
      plot.title = element_text(
        family = my_font,
        size = 15,
        hjust = 0.95,
        vjust = 0.95
      )
    ) +
    geom_smooth(method = "lm", se = TRUE, color = "#F9B208", size = 1, fill = "#FEA82F") +
    annotate(
      "text",
      x = -Inf, y = Inf,
      label = label_text,
      hjust = -0.2, vjust = 1.5,
      size = 6,
      family = "Times New Roman"
    ) 
}

# 分组绘图
plots <- lapply(years, function(y) {
  df_year <- df_clean %>% filter(年份 == y)
  create_plot(df_year, paste0(y, "年"))
})

# 添加“全样本”图
plots[[length(plots)+1]] <- create_plot(df_clean, "全样本")

# 设置输出目录
output_dir <- "D:/2浙江十五五土地计划课题/时空分析/出图"
if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)
output_path <- file.path(output_dir, "gdp_quota.jpeg")

# 绘制多图并保存为 JPEG
png(
  filename = output_path,
  width = 30,
  height = 20,
  units = "cm",
  res = 600,
  type = "cairo"
)

grid.arrange(
  grobs = plots,
  nrow = 2,
  ncol = 3
)

dev.off()

message("图像已保存至：", output_path)
